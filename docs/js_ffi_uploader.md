# JS FFI Uploader - Int√©gration temporaire du client officiel

## Vue d'ensemble

Solution temporaire pour utiliser le client JS officiel `@storacha/client` via un CLI Node, en attendant la parit√© compl√®te du client Dart natif.

**Objectif**: Uploads fonctionnels avec retrieval imm√©diat, changements minimaux dans l'app.

## Architecture

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Application Dart (quantum_agents)                          ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ  StorachaClient (API publique inchang√©e)             ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ  Feature Flag: USE_JS_UPLOADER                 ‚îÇ  ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ  ‚îú‚îÄ true  ‚Üí JsUploadAdapter                    ‚îÇ  ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ  ‚îî‚îÄ false ‚Üí Native Dart Upload (actuel)        ‚îÇ  ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚îÇ
                            ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  JsUploadAdapter (Dart)                                     ‚îÇ
‚îÇ  ‚Ä¢ Lance process Node: storacha-uploader.mjs                ‚îÇ
‚îÇ  ‚Ä¢ Envoie JSON via stdin (params + data base64)             ‚îÇ
‚îÇ  ‚Ä¢ Parse JSON stdout (root CID, shards, errors)             ‚îÇ
‚îÇ  ‚Ä¢ Map erreurs ‚Üí exceptions Dart                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚îÇ
                            ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  storacha-uploader.mjs (Node CLI)                           ‚îÇ
‚îÇ  ‚Ä¢ Commandes: upload-file, upload-car                       ‚îÇ
‚îÇ  ‚Ä¢ Utilise @storacha/client directement                     ‚îÇ
‚îÇ  ‚Ä¢ Output: JSON strict { root, shards, error? }            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## Contrat CLI

### Input (stdin JSON)

```json
{
  "command": "upload-file",
  "key": "MgCZT5vOnYZoTacEP1aRo...",
  "spaceDid": "did:key:z6Mkk...",
  "data": "base64_encoded_bytes",
  "options": {
    "chunkSize": 262144,
    "pieceHasher": true
  }
}
```

### Output (stdout JSON)

**Succ√®s:**
```json
{
  "success": true,
  "root": "bafybei...",
  "shards": ["bagbaiera..."],
  "duration_ms": 1234
}
```

**Erreur:**
```json
{
  "success": false,
  "error": {
    "code": "UPLOAD_FAILED",
    "message": "Failed to upload: network timeout",
    "details": {}
  }
}
```

### Exit codes

- `0`: Succ√®s
- `1`: Erreur g√©n√©rique
- `2`: Arguments invalides
- `3`: Authentification √©chou√©e
- `4`: R√©seau/timeout

## Activation

### Via environnement

```bash
export USE_JS_UPLOADER=true
export KEY="MgCZT5vOnYZoTacEP1aRo..."
dart run example/test_truly_unique.dart
```

### Via code

```dart
final client = await StorachaClient.create(
  principal: signer,
  store: store,
  config: ClientConfig(
    useJsUploader: true, // Feature flag
  ),
);
```

## D√©pendances

### Node (>=18)

```bash
node --version  # v18.0.0+
```

### Packages JS

```bash
cd storacha_dart/tool/js_uploader
npm install
# Installe: @storacha/client, @storacha/upload-client
```

## D√©veloppement

### Test rapide du CLI

```bash
cd storacha_dart/tool/js_uploader
echo '{"command":"upload-file","key":"...","spaceDid":"...","data":"SGVsbG8gV29ybGQ="}' | node storacha-uploader.mjs
```

### Test de l'adapter Dart

```dart
final adapter = JsUploadAdapter();
final result = await adapter.uploadFile(
  bytes: utf8.encode('Hello World'),
  key: 'MgCZT5v...',
  spaceDid: 'did:key:z6Mkk...',
);
print('Root CID: ${result.root}');
```

## Mapping d'erreurs

| Exit Code | Dart Exception | Description |
|-----------|----------------|-------------|
| 0 | - | Succ√®s |
| 1 | `StorachaException` | Erreur g√©n√©rique |
| 2 | `ArgumentError` | Params invalides |
| 3 | `AuthenticationException` | Cl√©/proofs invalides |
| 4 | `NetworkException` | Timeout/r√©seau |

## Limitations

- **Performance**: Overhead process spawn (~50-100ms)
- **Proofs**: Seules les d√©l√©gations via fichiers support√©es initialement
- **Progress**: Callbacks de progression non support√©s (v1)
- **Concurrence**: Un upload √† la fois par process

## Roadmap

1. ‚úÖ CLI minimal (upload-file)
2. ‚è≥ Adapter Dart + feature flag
3. ‚è≥ Test e2e avec retrieval imm√©diat
4. ‚è≥ Support upload-car
5. ‚è≥ Gestion proofs/delegations
6. ‚è≥ Progress callbacks via events JSON
7. ‚è≥ Pool de process pour concurrence
8. üîú Migration progressive vers Dart natif

## Fallback

Si Node indisponible ou CLI √©choue:
```dart
if (config.useJsUploader && !jsUploaderAvailable) {
  print('‚ö†Ô∏è  JS uploader unavailable, falling back to Dart');
  return _uploadFileDart(file);
}
```

## Notes

- Le CLI est **temporaire** - objectif: parit√© Dart compl√®te
- Les CARs/index g√©n√©r√©s par Dart sont corrects (v√©rifi√©)
- Le probl√®me actuel est dans le flow UCAN Dart (ucan/conclude, timing)
- Cette solution permet de d√©bloquer l'app pendant qu'on finalise Dart

